<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网盘媒体轮询入库</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }

        button {
            padding: 10px 15px;
            margin-right: 10px;
        }

        h2 {
            margin-top: 30px;
        }

        #log {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
            background: #f9f9f9;
        }

        .active {
            color: green;
        }

        .inactive {
            color: red;
        }

        .form-group-container.foldable {
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            max-height: 1000px;
        }

        .form-group-container.folded {
            max-height: 0;
        }

        .checkbox-with-button {
            display: flex;
            align-items: center;
        }

        .checkbox-with-button label {
            margin-right: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>网盘轮询入库</h1>
        <form method="POST">
            <button type="button" class="fold-toggle" id="foldToggle">隐藏参数</button>
            <div class="form-group-container foldable" id="foldableContent">
                <div class="form-group">
                    <label for="TELEGRAM_BOT_TOKEN">TELEGRAM_BOT_TOKEN:</label>
                    <input type="text" id="TELEGRAM_BOT_TOKEN" name="TELEGRAM_BOT_TOKEN"
                        value="{{ vars.get('TELEGRAM_BOT_TOKEN', '') }}">
                </div>
                <div class="form-group">
                    <label for="TELEGRAM_CHAT_ID">TELEGRAM_CHAT_ID:</label>
                    <input type="text" id="TELEGRAM_CHAT_ID" name="TELEGRAM_CHAT_ID"
                        value="{{ vars.get('TELEGRAM_CHAT_ID', '') }}">
                </div>
                <div class="form-group">
                    <label for="EMBY_SERVER_URL">EMBY_SERVER_URL:</label>
                    <input type="text" id="EMBY_SERVER_URL" name="EMBY_SERVER_URL"
                        value="{{ vars.get('EMBY_SERVER_URL', '') }}">
                </div>
                <div class="form-group">
                    <label for="EMBY_API_KEY">EMBY_API_KEY:</label>
                    <input type="text" id="EMBY_API_KEY" name="EMBY_API_KEY" value="{{ vars.get('EMBY_API_KEY', '') }}">
                </div>
                <div class="form-group">
                    <label for="source_dir">网盘监控目录路径:</label>
                    <input type="text" id="source_dir" name="source_dir" value="{{ vars.get('source_dir', '') }}">
                </div>
                <div class="form-group">
                    <label for="strm_dir">Strm文件存储路径:</label>
                    <input type="text" id="strm_dir" name="strm_dir" value="{{ vars.get('strm_dir', '') }}">
                </div>
                <div class="form-group">
                    <label for="docker_dir">Emby库路径:</label>
                    <input type="text" id="docker_dir" name="docker_dir" value="{{ vars.get('docker_dir', '') }}">
                </div>
                <div class="form-group">
                    <label for="library_dir">网盘最终库路径:</label>
                    <input type="text" id="library_dir" name="library_dir" value="{{ vars.get('library_dir', '') }}">
                </div>
                <div class="form-group">
                    <label for="cloud_dir">Strm补齐路径:</label>
                    <input type="text" id="cloud_dir" name="cloud_dir" value="{{ vars.get('cloud_dir', '') }}">
                </div>
                <div class="form-group">
                    <label for="path_layers">Emby库目录层级数:</label>
                    <input type="text" id="path_layers" name="path_layers" value="{{ vars.get('path_layers', '') }}">
                </div>
                <div class="checkbox-with-button">
                    <!-- 隐藏字段，初始值为'false' -->
                    <input type="hidden" name="path_delete" value="false" id="pathDeleteHidden">
                    <!-- 复选框 -->
                    <label>
                        <span>是否要清理目录残留</span>
                        <input type="checkbox" name="path_delete" value="true" id="pathDeleteCheckbox" {{ 'checked' if
                            vars.get('path_delete', '' )=='true' else '' }}> 删除路径
                    </label>
                    <button type="submit">提交</button>
                </div>
            </div>
            <button type="submit" name="start" class="{{ button_class }}">{{ button_text }}</button>
        </form>

        <h4>日志</h4>
        <form id="control-form">
            <button type="button" onclick="startLogStream()">开启日志流</button>
            <button type="button" onclick="stopLogStream()">停止日志流</button>
        </form>
        <div id="log">等待日志流数据...</div>
    </div>

    <script>
        var eventSource = null;

        function startLogStream() {
            if (eventSource === null) {
                eventSource = new EventSource("/logs");
                eventSource.onmessage = function (event) {
                    var logDiv = document.getElementById('log');
                    logDiv.innerHTML += event.data + '<br>';
                    logDiv.scrollTop = logDiv.scrollHeight;
                };
                eventSource.onerror = function (error) {
                    console.error("EventSource连接失败:", error);
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                    document.getElementById('log').innerHTML = "日志连接丢失，请刷新页面重试。";
                };
            }
        }

        function stopLogStream() {
            if (eventSource !== null) {
                eventSource.close();
                eventSource = null;
                document.getElementById('log').innerHTML += "<br>日志流已停止。";
            }
        }

        // 页面加载时初始化按钮状态
        document.addEventListener('DOMContentLoaded', function () {
            var button = document.querySelector('button[name="start"]');

            // 使用闭包来封装isActive状态，现在通过cookie获取和设置  
            function getMonitoringStatus() {
                var cookies = document.cookie.split("; ");
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i];
                    var eqPos = cookie.indexOf("=");
                    var name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie;
                    if (name === 'monitoring') {
                        return cookie.substr(eqPos + 1).trim() === 'true';
                    }
                }
                return false; // 默认未设置时为false  
            }

            var setMonitoringStatus = function (newStatus) {
                var date = new Date();
                date.setTime(date.getTime() + (3600 * 1000)); // 设置cookie有效期为1小时  
                var expires = "expires=" + date.toUTCString();
                var sameSite = "SameSite=Lax"; // 如果使用HTTPS，可以改为 "SameSite=None; Secure"  
                document.cookie = "monitoring=" + (newStatus ? 'true' : 'false') + "; " + expires + "; " + sameSite + "; path=/"; // 添加path属性以确保cookie在所有路径下都有效  
            };

            function updateButton() {
                var isActive = getMonitoringStatus();
                var buttonText = isActive ? '正在监控' : '开始监控';
                button.textContent = buttonText;
                button.classList.toggle('active', isActive);
            }

            updateButton(); // 初始更新按钮状态  

            button.addEventListener('click', function () {
                var newStatus = !getMonitoringStatus(); // 直接取反getMonitoringStatus()的返回值  
                setMonitoringStatus(newStatus);
                updateButton(); // 更新按钮状态  
                // 这里可以触发AJAX请求到服务器，真正开始或停止监控任务  
            });
        });


        // 折叠逻辑
        const foldToggle = document.getElementById('foldToggle');
        const foldableContent = document.getElementById('foldableContent');
        let isFolded = false;

        foldToggle.addEventListener('click', function () {
            isFolded = !isFolded;
            if (isFolded) {
                foldableContent.classList.add('folded');
                foldToggle.textContent = '显示参数';
            } else {
                foldableContent.classList.remove('folded');
                foldToggle.textContent = '隐藏参数';
            }
        });
document.addEventListener('DOMContentLoaded', function () {
            var checkbox = document.querySelector('input[name="path_delete"][type="checkbox"]');
            var storedValue = vars.get('library_dir', ''); /* 从某处获取存储的值，比如localStorage、cookie或服务器响应 */
            checkbox.checked = storedValue === 'true';
        });

        document.addEventListener('submit', function (event) {
            // 检查复选框是否被勾选  
            var checkbox = document.getElementById('pathDeleteCheckbox');
            var hiddenField = document.getElementById('pathDeleteHidden');

            // 如果复选框被勾选，则确保隐藏字段不会被提交  
            if (checkbox.checked) {
                hiddenField.disabled = true; // 禁用隐藏字段，这样它就不会被提交了  
            } else {
                hiddenField.disabled = false; // 启用隐藏字段，确保它被提交  
            }
        });
        // 页面加载时启动日志流

        startLogStream(); 
    </script>
</body>

</html>
